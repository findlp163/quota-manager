# Quota Manager 项目解析

## 项目概述

Quota Manager 是一个基于 Go 语言和 Gin 框架构建的综合配额管理系统，具有先进的配额分配、转账功能、权限管理和基于 JWT 的身份验证。

**主要技术栈：**
- Go 1.23.0
- Gin Web 框架
- GORM + PostgreSQL
- JWT 认证
- Zap 日志
- Cron 定时任务

## 完整目录结构

```
quota-manager/
├── 📁 cmd/                           # 应用程序入口点
│   └── 📄 main.go                   # 主程序入口文件
├── 📁 internal/                      # 内部包（私有代码）
│   ├── 📁 condition/                # 条件表达式解析
│   │   ├── 📄 adapters.go           # 条件适配器
│   │   └── 📄 parser.go             # 条件表达式解析器
│   ├── 📁 config/                   # 配置管理
│   │   ├── 📄 config.go             # 配置结构定义
│   │   └── 📄 manager.go            # 配置管理器
│   ├── 📁 database/                 # 数据库连接
│   │   └── 📄 database.go           # 数据库初始化和连接
│   ├── 📁 handlers/                 # HTTP 处理器
│   │   ├── 📄 aigateway_admin.go    # AiGateway 管理接口
│   │   ├── 📄 model_permission.go   # 模型权限管理
│   │   ├── 📄 quota_check_permission.go # 配额检查权限管理
│   │   ├── 📄 quota.go              # 配额管理接口
│   │   ├── 📄 scan.go               # 扫描触发接口
│   │   ├── 📄 star_check_permission.go # Star检查权限管理
│   │   ├── 📄 strategy_schema.go    # 策略模式验证
│   │   ├── 📄 strategy.go           # 策略管理接口
│   │   └── 📄 unified_permission.go # 统一权限查询接口
│   ├── 📁 models/                   # 数据模型
│   │   └── 📄 models.go             # 所有数据模型定义
│   ├── 📁 response/                 # 响应格式
│   │   └── 📄 response.go           # 统一响应格式定义
│   ├── 📁 services/                 # 业务逻辑服务
│   │   ├── 📄 aigateway_admin.go    # AiGateway 管理服务
│   │   ├── 📄 employee_sync.go      # 员工同步服务
│   │   ├── 📄 errors.go             # 错误定义
│   │   ├── 📄 permission.go         # 权限管理服务
│   │   ├── 📄 quota_check_permission.go # 配额检查权限服务
│   │   ├── 📄 quota.go              # 配额管理服务
│   │   ├── 📄 scheduler.go          # 定时任务调度服务
│   │   ├── 📄 star_check_permission.go # Star检查权限服务
│   │   ├── 📄 strategy.go           # 策略管理服务
│   │   ├── 📄 unified_permission.go # 统一权限服务
│   │   └── 📄 voucher.go            # 兑换码服务
│   ├── 📁 utils/                    # 工具函数
│   │   ├── 📄 retry.go              # 重试机制
│   │   └── 📄 timezone.go           # 时区处理
│   └── 📁 validation/               # 验证相关
│       ├── 📄 middleware.go         # 验证中间件
│       ├── 📄 schema.go             # 验证模式
│       └── 📄 validator.go          # 验证器
├── 📁 pkg/                          # 公共包（可被外部引用）
│   ├── 📁 aigateway/                # AiGateway 客户端
│   │   └── 📄 client.go             # AiGateway HTTP 客户端
│   └── 📁 logger/                   # 日志记录
│       └── 📄 logger.go             # Zap 日志配置
├── 📁 scripts/                      # 脚本文件
│   ├── 📁 aigateway-mock/           # AiGateway 模拟服务
│   │   ├── 📄 Dockerfile            # Docker 构建文件
│   │   ├── 📄 go.mod                # Go 模块文件
│   │   ├── 📄 go.sum                # Go 依赖校验
│   │   └── 📄 main.go               # 模拟服务主程序
│   ├── 📁 employee-sync-mock/       # 员工同步模拟服务
│   │   ├── 📄 Dockerfile            # Docker 构建文件
│   │   ├── 📄 employee-sync-mock    # 可执行文件
│   │   ├── 📄 go.mod                # Go 模块文件
│   │   ├── 📄 go.sum                # Go 依赖校验
│   │   ├── 📄 main.go               # 模拟服务主程序
│   │   └── 📄 README.md             # 说明文档
│   ├── 📄 init_db.sql               # 数据库初始化脚本
│   ├── 📄 start.sh                  # 启动脚本
│   └── 📄 test_api.sh               # API 测试脚本
├── 📁 test/                         # 集成测试
│   ├── 📄 api.go                    # API 测试工具
│   ├── 📄 common.go                 # 通用测试函数
│   ├── 📄 concurrent.go             # 并发测试
│   ├── 📄 condition_1.go            # 条件表达式测试 1
│   ├── 📄 condition_2.go            # 条件表达式测试 2
│   ├── 📄 condition_3.go            # 条件表达式测试 3
│   ├── 📄 condition_4.go            # 条件表达式测试 4
│   ├── 📄 condition_5.go            # 条件表达式测试 5
│   ├── 📄 config.yaml               # 测试配置文件
│   ├── 📄 go.mod                    # Go 模块文件
│   ├── 📄 go.sum                    # Go 依赖校验
│   ├── 📄 main.go                   # 测试主程序
│   ├── 📄 mock.go                   # 模拟数据生成
│   ├── 📄 periodic_strategy_1.go    # 周期策略测试 1
│   ├── 📄 periodic_strategy_2.go    # 周期策略测试 2
│   ├── 📄 permission_1.go           # 权限测试 1
│   ├── 📄 permission_2.go           # 权限测试 2
│   ├── 📄 permission_3.go           # 权限测试 3
│   ├── 📄 permission_4.go           # 权限测试 4
│   ├── 📄 permission_5.go           # 权限测试 5
│   ├── 📄 quota_check_permission_1.go # 配额检查权限测试 1
│   ├── 📄 quota_check_permission_2.go # 配额检查权限测试 2
│   ├── 📄 quota_check_permission_3.go # 配额检查权限测试 3
│   ├── 📄 quota_expiry_1.go         # 配额过期测试 1
│   ├── 📄 quota_expiry_2.go         # 配额过期测试 2
│   ├── 📄 quota_expiry_3.go         # 配额过期测试 3
│   ├── 📄 quota_expiry_4.go         # 配额过期测试 4
│   ├── 📄 quota_expiry_5.go         # 配额过期测试 5
│   ├── 📄 quota_expiry_helpers.go   # 配额过期测试辅助函数
│   ├── 📄 quota.go                  # 配额测试
│   ├── 📄 run_tests.sh              # 测试运行脚本
│   ├── 📄 schema_validation.go      # 模式验证测试
│   ├── 📄 star_check_permission_1.go # Star检查权限测试 1
│   ├── 📄 star_check_permission_2.go # Star检查权限测试 2
│   ├── 📄 star_check_permission_3.go # Star检查权限测试 3
│   ├── 📄 star_check_permission_4.go # Star检查权限测试 4
│   ├── 📄 strategy.go               # 策略测试
│   ├── 📄 transfer_github_star.go   # GitHub Star 转账测试
│   ├── 📄 transfer_in_1.go          # 转入测试 1
│   ├── 📄 transfer_in_2.go          # 转入测试 2
│   ├── 📄 transfer_out.go           # 转出测试
│   └── 📄 validation.go             # 验证测试
├── 📄 .gitignore                    # Git 忽略文件配置
├── 📄 config.yaml                   # 主配置文件
├── 📄 docker-compose.yml            # Docker Compose 配置
├── 📄 Dockerfile                    # Docker 构建文件
├── 📄 go.mod                        # Go 模块文件
├── 📄 go.sum                        # Go 依赖校验文件
├── 📄 Makefile                      # 构建脚本
├── 📄 README.md                     # 英文说明文档
└── 📄 README_CN.md                  # 中文说明文档
```

## 核心功能模块

### 功能总览

Quota Manager 系统包含以下10个核心功能模块：

| 模块 | 主要功能 | 核心特性 |
|------|----------|----------|
| **策略管理** | 配额充值策略的创建和执行 | 支持一次性/周期性策略、条件表达式、定时执行 |
| **配额管理** | 用户配额的分配、转账和过期处理 | 兑换码转账、多过期时间、审计跟踪 |
| **权限管理** | 模型访问权限的精细化控制 | 用户/部门级权限、层级继承、实时同步 |
| **Star检查权限** | GitHub Star检查开关管理 | 用户/部门级控制、优先级管理 |
| **配额检查权限** | 配额检查开关管理 | 用户/部门级控制、默认策略 |
| **员工同步** | HR系统数据自动同步 | 定时同步、手动触发、权限自动更新 |
| **条件表达式** | 复杂业务逻辑的表达式解析 | 支持11种函数、逻辑运算、灵活组合 |
| **兑换码系统** | 安全的配额转账机制 | HMAC-SHA256签名、防重复兑换 |
| **定时任务** | 自动化任务调度执行 | Cron调度、策略执行、过期处理 func (s *SchedulerService) Start() |
| **AiGateway集成** | 与AI网关的数据同步 | 配额同步、权限同步、实时更新 |

---

### 详细模块分析

### 1. 策略管理 (Strategy Management)
**文件位置：** `internal/services/strategy.go`, `internal/handlers/strategy.go`

**功能特性：**
- 一次性和周期性充值策略类型
- 策略状态控制（启用/禁用）
- 复杂条件匹配（支持高级函数条件表达式）
- 定时任务执行（基于 Cron 表达式）
- 策略执行记录跟踪

**主要 API：**
- `POST /quota-manager/api/v1/strategies` - 创建策略
- `GET /quota-manager/api/v1/strategies` - 获取策略列表
- `PUT /quota-manager/api/v1/strategies/:id` - 更新策略
- `POST /quota-manager/api/v1/strategies/:id/enable` - 启用策略
- `POST /quota-manager/api/v1/strategies/:id/disable` - 禁用策略

### 2. 配额管理 (Quota Management)
**文件位置：** `internal/services/quota.go`, `internal/handlers/quota.go`

**功能特性：**
- 配额过期管理（基于时间的配额管理）
- 配额转账功能（使用兑换码）
- 审计跟踪（全面的配额操作跟踪）
- 多种过期日期支持
- 与 AiGateway 服务实时同步

**主要 API：**
- `GET /quota-manager/api/v1/quota` - 获取用户配额
- `POST /quota-manager/api/v1/quota/transfer-out` - 转出配额
- `POST /quota-manager/api/v1/quota/transfer-in` - 转入配额
- `GET /quota-manager/api/v1/quota/audit` - 获取配额审计记录

### 3. 权限管理 (Permission Management)
**文件位置：** `internal/services/permission.go`, `internal/handlers/model_permission.go`

**功能特性：**
- 模型访问权限管理
- 用户和部门级别的细粒度控制
- 部门层级权限继承
- 与 AI Gateway 的自动权限同步
- 审计跟踪

**主要 API：**
- `POST /quota-manager/api/v1/model-permissions/user` - 设置用户白名单
- `POST /quota-manager/api/v1/model-permissions/department` - 设置部门白名单

### 4. Star 检查权限管理 (Star Check Permission)
**文件位置：** `internal/services/star_check_permission.go`, `internal/handlers/star_check_permission.go`

**功能特性：**
- GitHub Star 检查开关管理
- 用户和部门级别控制
- 权限继承机制
- 优先级管理（用户设置优先于部门设置）

**主要 API：**
- `POST /quota-manager/api/v1/star-check-permissions/user` - 设置用户 Star 检查开关
- `POST /quota-manager/api/v1/star-check-permissions/department` - 设置部门 Star 检查开关

### 5. 配额检查权限管理 (Quota Check Permission)
**文件位置：** `internal/services/quota_check_permission.go`, `internal/handlers/quota_check_permission.go`

**功能特性：**
- 配额检查开关管理
- 用户和部门级别控制
- 默认禁用策略
- 权限继承和优先级管理

**主要 API：**
- `POST /quota-manager/api/v1/quota-check-permissions/user` - 设置用户配额检查开关
- `POST /quota-manager/api/v1/quota-check-permissions/department` - 设置部门配额检查开关

### 6. 员工同步 (Employee Sync)
**文件位置：** `internal/services/employee_sync.go`

**功能特性：**
- 自动化 HR 系统集成
- 员工和部门数据同步
- 定时同步（每天凌晨 1:00）
- 手动触发同步
- 权限自动更新

### 7. 条件表达式系统 (Condition Expression)
**文件位置：** `internal/condition/parser.go`, `internal/condition/adapters.go`

**支持的函数：**
- `access-after(timestamp)` - 指定时间后的最后访问
- `and(condition1, condition2)` - 逻辑与
- `belong-to(org1, org2)` - 属于指定组织或部门
- `false()` - 始终返回 false
- `github-star(project)` - 检查用户是否为指定项目加星
- `is-vip(level)` - VIP 等级检查
- `match-user("user1", "user2", ...)` - 匹配用户ID
- `not(condition)` - 逻辑非
- `or(condition1, condition2)` - 逻辑或
- `quota-le(model, amount)` - 配额余额检查
- `register-before(timestamp)` - 指定时间前注册
- `true()` - 始终返回 true

### 8. 兑换码系统 (Voucher System)
**文件位置：** `internal/services/voucher.go`

**安全特性：**
- HMAC-SHA256 签名验证
- Base64URL 编码
- 重复兑换防护
- 时间戳验证

### 9. 定时任务系统 (Scheduler)
**文件位置：** `internal/services/scheduler.go`

**任务类型：**
- 策略执行任务（每小时执行）
- 配额过期任务（每月第一天 00:01）
- 员工同步任务（每天凌晨 1:00）

### 10. AiGateway 集成
**文件位置：** `pkg/aigateway/client.go`, `internal/services/aigateway_admin.go`

**集成功能：**
- 配额刷新和查询
- 已使用配额管理
- Star 项目管理
- 权限同步
- 模型权限设置

## 数据库架构

### 核心表结构

#### 策略相关表
- `quota_strategy` - 配额策略表
- `quota_execute` - 策略执行状态表

#### 配额相关表
- `quota` - 用户配额表
- `quota_audit` - 配额审计表
- `voucher_redemption` - 兑换码兑换表
- `monthly_quota_usage` - 月度配额使用记录表

#### 用户认证表
- `auth_users` - 用户信息表（位于独立的 auth 数据库）

#### 权限管理表
- `employee_department` - 员工部门表
- `model_whitelist` - 模型白名单表
- `effective_permissions` - 有效权限表
- `permission_audit` - 权限审计表

#### Star 检查表
- `star_check_settings` - Star 检查设置表
- `effective_star_check_settings` - 有效 Star 检查设置表

#### 配额检查表
- `quota_check_settings` - 配额检查设置表
- `effective_quota_check_settings` - 有效配额检查设置表

## 配置系统

### 主要配置项
```yaml
server:           # 服务器配置
  port: 8099
  mode: "release"
  token_header: "authorization"

database:         # 主数据库配置
  host: "127.0.0.1"
  port: 5432
  user: "keycloak"
  password: "sf2025~SHENMA"
  dbname: "quota_manager"

auth_database:    # 认证数据库配置
  host: "127.0.0.1"
  port: 5432
  user: "keycloak"
  password: "sf2025~SHENMA"
  dbname: "auth"

aigateway:        # AiGateway 集成配置
  host: "127.0.0.1"
  port: 8002
  admin_path: "/v1/chat/completions/quota"
  auth_header: "x-admin-key"
  auth_value: "12345678"

employee_sync:    # 员工同步配置
  enabled: false
  hr_url: "http://localhost:8099/api/hr/employees"
  hr_key: "test-hr-key"
  dept_url: "http://localhost:8099/api/hr/departments"
  dept_key: "test-dept-key"

voucher:          # 兑换码配置
  signing_key: "your-secret-signing-key-at-least-32-bytes-long-for-security"

log:              # 日志配置
  level: "warn"
  stdout_only: true

timezone: "Asia/Shanghai"  # 时区配置
```

## 测试系统

### 测试覆盖范围
- **条件表达式测试**：所有支持的函数和逻辑组合
- **策略类型测试**：一次性和周期性策略
- **状态控制测试**：启用/禁用功能
- **配额转账测试**：转出/转入操作
- **审计跟踪测试**：记录跟踪和查询
- **过期管理测试**：基于时间的配额处理
- **权限管理测试**：模型权限、Star 检查权限、配额检查权限
- **AiGateway 集成测试**：正常和失败场景
- **并发测试**：多用户并发操作
- **验证测试**：输入验证和模式验证

### 测试运行方式
```bash
# 运行集成测试
cd test
chmod +x run_tests.sh
./run_tests.sh

# 或手动运行
go run main.go
```

## 部署和运维

### Docker 支持
- `Dockerfile` - 主应用容器构建
- `docker-compose.yml` - 完整环境编排
- `scripts/aigateway-mock/Dockerfile` - 模拟服务容器

### 启动脚本
- `scripts/start.sh` - 完整启动脚本
- `scripts/test_api.sh` - API 测试脚本

### 数据库初始化
- `scripts/init_db.sql` - 完整的数据库结构初始化脚本

## 安全特性

1. **JWT 认证**：所有 API 端点都需要有效的 JWT 令牌
2. **HMAC-SHA256 兑换码**：加密签名的兑换码系统
3. **重复防护**：防止重复兑换和操作
4. **事务安全**：数据库事务保证数据一致性
5. **权限分级**：用户、部门多级权限控制
6. **审计跟踪**：完整的操作记录和审计

## 性能优化

1. **数据库索引**：关键字段建立高效索引
2. **连接池**：数据库连接池管理
3. **批处理**：大型操作的批量处理
4. **缓存机制**：配置和权限数据缓存
5. **异步处理**：定时任务异步执行

## 监控和日志

1. **结构化日志**：使用 Zap 进行 JSON 格式日志记录
2. **健康检查**：`/quota-manager/health` 端点
3. **错误跟踪**：详细的错误信息和堆栈跟踪
4. **性能指标**：操作执行时间和资源使用跟踪
5. **审计日志**：所有关键操作的审计记录

## 核心机制深度解析：配额计算与扣除

### 1. 配额管理模式：本地记账 + 外部消耗

为了实现高性能和职责分离，系统采用了**本地数据库记账**与**外部服务消耗计量**相结合的混合模式。

- **`quota-manager` (本地数据库)**: 负责配额的**生命周期管理**，像一个**总账本**。它记录了所有配额的授予（`INSERT`）、内部转移/扣减（`UPDATE`）和过期处理。
- **`AiGateway` (外部服务)**: 负责配额的**实时消耗计量**，像一个**高频消费记录器**。它独立记录用户的日常使用消耗（`usedQuota`），而不直接修改 `quota-manager` 的总账本。

### 2. `quota.Amount` 字段的核心含义

`quota` 表中的 `Amount` 字段是理解本系统的关键。

- **含义**: 它代表**“特定批次授予额度的当前剩余值”**，即 `原始授予值 - 所有内部账本扣减`。
- **非实时可用余额**: `SUM(quota.Amount)` 得到的**不是**用户最终的可用配额，而是一个**理论总额**。

### 3. `quota.Amount` 的变更时机

`quota.Amount` 的值**仅在以下低频的“内部账本调整”操作时会减少**：

| 操作类型 | 触发函数 | 业务场景 |
| :--- | :--- | :--- |
| **配额转出** | `TransferOut` | 用户 A 将配额转给用户 B 时，扣减 A 的 `Amount`。 |
| **手动扣除** | `DeductQuota` | 管理员因特定原因（如冲正、结算）扣减用户的 `Amount`。 |

**重要**: 用户的**日常使用消耗**（调用 AI 模型）由 `AiGateway` 记录，**不会**改变 `quota` 表中的 `Amount` 值。

### 4. 最终可用配额的计算逻辑 (`GetUserQuota`)

用户的**最终可用配额**是一个**动态计算**出来的实时值，计算过程好比“对账”。

**计算公式**:
\[ \text{最终可用配额} = (\sum \text{所有有效 quota.Amount}) - \text{usedQuota (来自 AiGateway)} \]

**执行流程**:
1. **获取消耗总额**: 从 `AiGateway` 获取权威的 `usedQuota`。
2. **获取理论总额**: 从本地数据库 `quota` 表中，将用户所有 `status = 'VALID'` 的记录的 `Amount` 相加。
3. **计算差值**: `理论总额 - 消耗总额`，得到最终可用配额。

### 5. 配额扣除规则 (FIFO)

所有配额的扣除（无论是内部扣减还是外部消耗的计算），都遵循**先进先出 (First-In, First-Out)** 的原则。

- **规则**: **最早过期的配额批次，最先被扣除**。
- **实现**: 所有相关的数据库查询都使用 `ORDER BY expiry_date ASC` 来保证顺序。

### 6. 默认有效期计算规则 (硬编码)

**关键点**: 系统默认的“次月月底失效”规则，**并非在 `config.yaml` 或数据库中配置，而是硬编码（Hard-coded）在核心业务代码中**。

*   **代码位置**: `internal/services/quota.go` -> `Recharge` 函数。
*   **核心逻辑**: 当一个策略**没有**定义 `validity_days` 时，`Recharge` 函数会通过一段固定的日期计算逻辑来生成 `ExpiryDate`。
    ```go
    // 简化逻辑：取“下下个月的第一天”，再减去1秒
    expiryDate := time.Date(now.Year(), now.Month(), 1, ...).AddDate(0, 2, 0).Add(-time.Second)
    ```
    这个计算方式确保了所有常规赠送的额度，其有效期都统一为**下一个月的最后一天**。
*   **灵活性来源**: 新增的 `validity_days` 字段，其目的正是为了能够**覆盖**这个默认的硬编码行为，从而实现如“180天有效”等灵活的有效期需求。

## 总结

Quota Manager 是一个功能完整、架构清晰的企业级配额管理系统，具备以下特点：

- **模块化设计**：清晰的分层架构，便于维护和扩展
- **功能全面**：涵盖配额管理、权限控制、员工同步等多个方面
- **安全可靠**：完善的认证、授权和审计机制
- **测试完整**：全面的集成测试和单元测试
- **部署便捷**：Docker 支持和自动化脚本
- **文档详细**：完整的中英文文档和 API 说明

该系统适用于需要精细化配额管理和权限控制的企业环境，特别是与 AI 服务集成的场景。

## API 接口文档

Quota Manager 提供了完整的 RESTful API 接口，所有接口都在 `/quota-manager/api/v1` 路径下。

### 基础信息

- **Base URL**: `http://localhost:8099/quota-manager/api/v1`
- **认证方式**: JWT Token (通过 `authorization` 头传递)
- **响应格式**: JSON
- **CORS**: 支持跨域请求

### 健康检查

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/quota-manager/health` | 服务健康检查 |

### 1. 策略管理 API (Strategies)

**基础路径**: `/strategies`

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| POST | `/strategies` | 创建配额策略 | Body: 策略信息 |
| GET | `/strategies` | 获取策略列表 | Query: page, size, name, type, status |
| GET | `/strategies/{id}` | 获取单个策略详情 | Path: id |
| PUT | `/strategies/{id}` | 更新策略信息 | Path: id, Body: 策略信息 |
| DELETE | `/strategies/{id}` | 删除策略 | Path: id |
| POST | `/strategies/{id}/enable` | 启用策略 | Path: id |
| POST | `/strategies/{id}/disable` | 禁用策略 | Path: id |
| GET | `/strategies/{id}/executions` | 获取策略执行记录 | Path: id, Query: page, size |

**策略创建/更新参数**:
```json
{
  "name": "策略名称（唯一）",
  "title": "策略标题",
  "type": "single|periodic",
  "amount": 100.0,
  "model": "模型名称（可选）",
  "periodic_expr": "Cron表达式（周期性策略必需）",
  "condition": "条件表达式",
  "status": true,
  "validity_days": 30
}
```

### 2. 配额管理 API (Quota)

**基础路径**: `/quota`

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/quota` | 获取用户配额信息 | Header: authorization |
| GET | `/quota/audit` | 获取配额审计记录 | Query: page, size |
| POST | `/quota/transfer-out` | 转出配额 | Body: 转出信息 |
| POST | `/quota/transfer-in` | 转入配额（兑换） | Body: 兑换码信息 |
| GET | `/quota/audit/{user_id}` | 获取指定用户审计记录（管理员） | Path: user_id |

**转出配额参数**:
```json
{
  "receiver_id": "接收方用户ID",
  "quota_list": [
    {
      "amount": 50.0,
      "expiry_date": "2025-12-31T23:59:59Z"
    }
  ]
}
```

**转入配额参数**:
```json
{
  "voucher_code": "兑换码"
}
```

### 3. 模型权限管理 API (Model Permissions)

**基础路径**: `/model-permissions`

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| POST | `/model-permissions/user` | 设置用户模型白名单 | Body: 用户权限信息 |
| POST | `/model-permissions/department` | 设置部门模型白名单 | Body: 部门权限信息 |
| GET | `/model-permissions/user` | 获取用户模型白名单 | Query: user_id 或 employee_number |
| GET | `/model-permissions/department` | 获取部门模型白名单 | Query: department_id |

**用户权限设置参数**:
```json
{
  "user_id": "用户ID",
  "employee_number": "员工编号",
  "models": ["gpt-3.5-turbo", "gpt-4"],
  "action": "set|add|remove"
}
```

### 4. Star 检查权限管理 API (Star Check Permissions)

**基础路径**: `/star-check-permissions`

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| POST | `/star-check-permissions/user` | 设置用户 Star 检查开关 | Body: 用户设置 |
| POST | `/star-check-permissions/department` | 设置部门 Star 检查开关 | Body: 部门设置 |
| GET | `/star-check-permissions/user` | 获取用户 Star 检查设置 | Query: user_id 或 employee_number |
| GET | `/star-check-permissions/department` | 获取部门 Star 检查设置 | Query: department_id |

**设置参数**:
```json
{
  "user_id": "用户ID",
  "employee_number": "员工编号",
  "enabled": true
}
```

### 5. 配额检查权限管理 API (Quota Check Permissions)

**基础路径**: `/quota-check-permissions`

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| POST | `/quota-check-permissions/user` | 设置用户配额检查开关 | Body: 用户设置 |
| POST | `/quota-check-permissions/department` | 设置部门配额检查开关 | Body: 部门设置 |
| GET | `/quota-check-permissions/user` | 获取用户配额检查设置 | Query: user_id 或 employee_number |
| GET | `/quota-check-permissions/department` | 获取部门配额检查设置 | Query: department_id |

### 6. 统一权限查询 API (Effective Permissions)

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/effective-permissions` | 统一权限查询接口 | Query: type, target_type, target_identifier |

**查询参数**:
- `type`: `model|star-check|quota-check`
- `target_type`: `user|department`
- `target_identifier`: 用户ID/员工编号或部门ID

### 7. 系统管理 API (Scan)

| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| POST | `/scan` | 触发系统扫描任务 | Body: 扫描类型 |

**扫描类型**:
```json
{
  "type": "strategy|employee-sync|expire-quotas|sync-quotas"
}
```

### 8. AI Gateway 管理 API (AiGateway Admin)

**基础路径**: `/aigateway`

#### 配额管理
| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/aigateway/quota` | 查询用户总配额 | Query: user_id |
| POST | `/aigateway/quota/refresh` | 刷新用户总配额 | Body: user_id, quota |
| POST | `/aigateway/quota/delta` | 增减用户总配额 | Body: user_id, value |

#### 已使用配额管理
| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/aigateway/quota-used` | 查询用户已使用配额 | Query: user_id |
| POST | `/aigateway/quota-used/refresh` | 刷新用户已使用配额 | Body: user_id, quota |
| POST | `/aigateway/quota-used/delta` | 增减用户已使用配额 | Body: user_id, value |

#### Star 项目管理
| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/aigateway/star/projects` | 查询用户 Star 项目 | Query: employee_number |
| POST | `/aigateway/star/projects` | 设置用户 Star 项目 | Body: employee_number, projects |

#### 权限开关管理
| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/aigateway/permission/star-check` | 查询 Star 检查开关 | Query: employee_number |
| POST | `/aigateway/permission/star-check` | 设置 Star 检查开关 | Body: employee_number, enabled |
| GET | `/aigateway/permission/quota-check` | 查询配额检查开关 | Query: employee_number |
| POST | `/aigateway/permission/quota-check` | 设置配额检查开关 | Body: employee_number, enabled |

#### 模型权限管理
| 方法 | 路径 | 描述 | 参数 |
|------|------|------|------|
| GET | `/aigateway/permission/models` | 获取用户模型权限 | Query: employee_number |
| POST | `/aigateway/permission/models` | 设置用户模型权限 | Body: employee_number, models |

### 响应格式

#### 成功响应
```json
{
  "code": "success",
  "message": "操作成功",
  "success": true,
  "data": {
    // 具体数据
  }
}
```

#### 错误响应
```json
{
  "code": "error_code",
  "message": "错误描述",
  "success": false
}
```

### 常见错误码

| 错误码 | 描述 |
|--------|------|
| `bad_request` | 请求参数错误 |
| `unauthorized` | 未授权访问 |
| `forbidden` | 权限不足 |
| `not_found` | 资源不存在 |
| `internal_server_error` | 服务器内部错误 |
| `strategy_not_found` | 策略不存在 |
| `user_not_found` | 用户不存在 |
| `insufficient_quota` | 配额不足 |
| `voucher_invalid` | 兑换码无效 |
| `employee_sync_failed` | 员工同步失败 |

### 分页参数

大多数列表接口支持分页：
- `page`: 页码（从1开始，默认1）
- `size`: 每页大小（默认10，最大100）

### 时间格式

所有时间字段使用 RFC3339 格式：`2006-01-02T15:04:05Z07:00`
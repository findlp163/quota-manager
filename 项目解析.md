# Quota Manager é¡¹ç›®è§£æ

## é¡¹ç›®æ¦‚è¿°

Quota Manager æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å’Œ Gin æ¡†æ¶æ„å»ºçš„ç»¼åˆé…é¢ç®¡ç†ç³»ç»Ÿï¼Œå…·æœ‰å…ˆè¿›çš„é…é¢åˆ†é…ã€è½¬è´¦åŠŸèƒ½ã€æƒé™ç®¡ç†å’ŒåŸºäº JWT çš„èº«ä»½éªŒè¯ã€‚

**ä¸»è¦æŠ€æœ¯æ ˆï¼š**
- Go 1.23.0
- Gin Web æ¡†æ¶
- GORM + PostgreSQL
- JWT è®¤è¯
- Zap æ—¥å¿—
- Cron å®šæ—¶ä»»åŠ¡

## å®Œæ•´ç›®å½•ç»“æ„

```
quota-manager/
â”œâ”€â”€ ğŸ“ cmd/                           # åº”ç”¨ç¨‹åºå…¥å£ç‚¹
â”‚   â””â”€â”€ ğŸ“„ main.go                   # ä¸»ç¨‹åºå…¥å£æ–‡ä»¶
â”œâ”€â”€ ğŸ“ internal/                      # å†…éƒ¨åŒ…ï¼ˆç§æœ‰ä»£ç ï¼‰
â”‚   â”œâ”€â”€ ğŸ“ condition/                # æ¡ä»¶è¡¨è¾¾å¼è§£æ
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ adapters.go           # æ¡ä»¶é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ parser.go             # æ¡ä»¶è¡¨è¾¾å¼è§£æå™¨
â”‚   â”œâ”€â”€ ğŸ“ config/                   # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ config.go             # é…ç½®ç»“æ„å®šä¹‰
â”‚   â”‚   â””â”€â”€ ğŸ“„ manager.go            # é…ç½®ç®¡ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“ database/                 # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ ğŸ“„ database.go           # æ•°æ®åº“åˆå§‹åŒ–å’Œè¿æ¥
â”‚   â”œâ”€â”€ ğŸ“ handlers/                 # HTTP å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ aigateway_admin.go    # AiGateway ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ model_permission.go   # æ¨¡å‹æƒé™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ quota_check_permission.go # é…é¢æ£€æŸ¥æƒé™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ quota.go              # é…é¢ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ scan.go               # æ‰«æè§¦å‘æ¥å£
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ star_check_permission.go # Staræ£€æŸ¥æƒé™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ strategy_schema.go    # ç­–ç•¥æ¨¡å¼éªŒè¯
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ strategy.go           # ç­–ç•¥ç®¡ç†æ¥å£
â”‚   â”‚   â””â”€â”€ ğŸ“„ unified_permission.go # ç»Ÿä¸€æƒé™æŸ¥è¯¢æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ models/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ ğŸ“„ models.go             # æ‰€æœ‰æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ ğŸ“ response/                 # å“åº”æ ¼å¼
â”‚   â”‚   â””â”€â”€ ğŸ“„ response.go           # ç»Ÿä¸€å“åº”æ ¼å¼å®šä¹‰
â”‚   â”œâ”€â”€ ğŸ“ services/                 # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ aigateway_admin.go    # AiGateway ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ employee_sync.go      # å‘˜å·¥åŒæ­¥æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ errors.go             # é”™è¯¯å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ permission.go         # æƒé™ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ quota_check_permission.go # é…é¢æ£€æŸ¥æƒé™æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ quota.go              # é…é¢ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ scheduler.go          # å®šæ—¶ä»»åŠ¡è°ƒåº¦æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ star_check_permission.go # Staræ£€æŸ¥æƒé™æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ strategy.go           # ç­–ç•¥ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ unified_permission.go # ç»Ÿä¸€æƒé™æœåŠ¡
â”‚   â”‚   â””â”€â”€ ğŸ“„ voucher.go            # å…‘æ¢ç æœåŠ¡
â”‚   â”œâ”€â”€ ğŸ“ utils/                    # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ retry.go              # é‡è¯•æœºåˆ¶
â”‚   â”‚   â””â”€â”€ ğŸ“„ timezone.go           # æ—¶åŒºå¤„ç†
â”‚   â””â”€â”€ ğŸ“ validation/               # éªŒè¯ç›¸å…³
â”‚       â”œâ”€â”€ ğŸ“„ middleware.go         # éªŒè¯ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ ğŸ“„ schema.go             # éªŒè¯æ¨¡å¼
â”‚       â””â”€â”€ ğŸ“„ validator.go          # éªŒè¯å™¨
â”œâ”€â”€ ğŸ“ pkg/                          # å…¬å…±åŒ…ï¼ˆå¯è¢«å¤–éƒ¨å¼•ç”¨ï¼‰
â”‚   â”œâ”€â”€ ğŸ“ aigateway/                # AiGateway å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ ğŸ“„ client.go             # AiGateway HTTP å®¢æˆ·ç«¯
â”‚   â””â”€â”€ ğŸ“ logger/                   # æ—¥å¿—è®°å½•
â”‚       â””â”€â”€ ğŸ“„ logger.go             # Zap æ—¥å¿—é…ç½®
â”œâ”€â”€ ğŸ“ scripts/                      # è„šæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ aigateway-mock/           # AiGateway æ¨¡æ‹ŸæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Dockerfile            # Docker æ„å»ºæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ go.mod                # Go æ¨¡å—æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ go.sum                # Go ä¾èµ–æ ¡éªŒ
â”‚   â”‚   â””â”€â”€ ğŸ“„ main.go               # æ¨¡æ‹ŸæœåŠ¡ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ ğŸ“ employee-sync-mock/       # å‘˜å·¥åŒæ­¥æ¨¡æ‹ŸæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Dockerfile            # Docker æ„å»ºæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ employee-sync-mock    # å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ go.mod                # Go æ¨¡å—æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ go.sum                # Go ä¾èµ–æ ¡éªŒ
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ main.go               # æ¨¡æ‹ŸæœåŠ¡ä¸»ç¨‹åº
â”‚   â”‚   â””â”€â”€ ğŸ“„ README.md             # è¯´æ˜æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ init_db.sql               # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ start.sh                  # å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ ğŸ“„ test_api.sh               # API æµ‹è¯•è„šæœ¬
â”œâ”€â”€ ğŸ“ test/                         # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ ğŸ“„ api.go                    # API æµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ ğŸ“„ common.go                 # é€šç”¨æµ‹è¯•å‡½æ•°
â”‚   â”œâ”€â”€ ğŸ“„ concurrent.go             # å¹¶å‘æµ‹è¯•
â”‚   â”œâ”€â”€ ğŸ“„ condition_1.go            # æ¡ä»¶è¡¨è¾¾å¼æµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ condition_2.go            # æ¡ä»¶è¡¨è¾¾å¼æµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ condition_3.go            # æ¡ä»¶è¡¨è¾¾å¼æµ‹è¯• 3
â”‚   â”œâ”€â”€ ğŸ“„ condition_4.go            # æ¡ä»¶è¡¨è¾¾å¼æµ‹è¯• 4
â”‚   â”œâ”€â”€ ğŸ“„ condition_5.go            # æ¡ä»¶è¡¨è¾¾å¼æµ‹è¯• 5
â”‚   â”œâ”€â”€ ğŸ“„ config.yaml               # æµ‹è¯•é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ go.mod                    # Go æ¨¡å—æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ go.sum                    # Go ä¾èµ–æ ¡éªŒ
â”‚   â”œâ”€â”€ ğŸ“„ main.go                   # æµ‹è¯•ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ ğŸ“„ mock.go                   # æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ
â”‚   â”œâ”€â”€ ğŸ“„ periodic_strategy_1.go    # å‘¨æœŸç­–ç•¥æµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ periodic_strategy_2.go    # å‘¨æœŸç­–ç•¥æµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ permission_1.go           # æƒé™æµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ permission_2.go           # æƒé™æµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ permission_3.go           # æƒé™æµ‹è¯• 3
â”‚   â”œâ”€â”€ ğŸ“„ permission_4.go           # æƒé™æµ‹è¯• 4
â”‚   â”œâ”€â”€ ğŸ“„ permission_5.go           # æƒé™æµ‹è¯• 5
â”‚   â”œâ”€â”€ ğŸ“„ quota_check_permission_1.go # é…é¢æ£€æŸ¥æƒé™æµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ quota_check_permission_2.go # é…é¢æ£€æŸ¥æƒé™æµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ quota_check_permission_3.go # é…é¢æ£€æŸ¥æƒé™æµ‹è¯• 3
â”‚   â”œâ”€â”€ ğŸ“„ quota_expiry_1.go         # é…é¢è¿‡æœŸæµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ quota_expiry_2.go         # é…é¢è¿‡æœŸæµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ quota_expiry_3.go         # é…é¢è¿‡æœŸæµ‹è¯• 3
â”‚   â”œâ”€â”€ ğŸ“„ quota_expiry_4.go         # é…é¢è¿‡æœŸæµ‹è¯• 4
â”‚   â”œâ”€â”€ ğŸ“„ quota_expiry_5.go         # é…é¢è¿‡æœŸæµ‹è¯• 5
â”‚   â”œâ”€â”€ ğŸ“„ quota_expiry_helpers.go   # é…é¢è¿‡æœŸæµ‹è¯•è¾…åŠ©å‡½æ•°
â”‚   â”œâ”€â”€ ğŸ“„ quota.go                  # é…é¢æµ‹è¯•
â”‚   â”œâ”€â”€ ğŸ“„ run_tests.sh              # æµ‹è¯•è¿è¡Œè„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ schema_validation.go      # æ¨¡å¼éªŒè¯æµ‹è¯•
â”‚   â”œâ”€â”€ ğŸ“„ star_check_permission_1.go # Staræ£€æŸ¥æƒé™æµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ star_check_permission_2.go # Staræ£€æŸ¥æƒé™æµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ star_check_permission_3.go # Staræ£€æŸ¥æƒé™æµ‹è¯• 3
â”‚   â”œâ”€â”€ ğŸ“„ star_check_permission_4.go # Staræ£€æŸ¥æƒé™æµ‹è¯• 4
â”‚   â”œâ”€â”€ ğŸ“„ strategy.go               # ç­–ç•¥æµ‹è¯•
â”‚   â”œâ”€â”€ ğŸ“„ transfer_github_star.go   # GitHub Star è½¬è´¦æµ‹è¯•
â”‚   â”œâ”€â”€ ğŸ“„ transfer_in_1.go          # è½¬å…¥æµ‹è¯• 1
â”‚   â”œâ”€â”€ ğŸ“„ transfer_in_2.go          # è½¬å…¥æµ‹è¯• 2
â”‚   â”œâ”€â”€ ğŸ“„ transfer_out.go           # è½¬å‡ºæµ‹è¯•
â”‚   â””â”€â”€ ğŸ“„ validation.go             # éªŒè¯æµ‹è¯•
â”œâ”€â”€ ğŸ“„ .gitignore                    # Git å¿½ç•¥æ–‡ä»¶é…ç½®
â”œâ”€â”€ ğŸ“„ config.yaml                   # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ docker-compose.yml            # Docker Compose é…ç½®
â”œâ”€â”€ ğŸ“„ Dockerfile                    # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ ğŸ“„ go.mod                        # Go æ¨¡å—æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ go.sum                        # Go ä¾èµ–æ ¡éªŒæ–‡ä»¶
â”œâ”€â”€ ğŸ“„ Makefile                      # æ„å»ºè„šæœ¬
â”œâ”€â”€ ğŸ“„ README.md                     # è‹±æ–‡è¯´æ˜æ–‡æ¡£
â””â”€â”€ ğŸ“„ README_CN.md                  # ä¸­æ–‡è¯´æ˜æ–‡æ¡£
```

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### åŠŸèƒ½æ€»è§ˆ

Quota Manager ç³»ç»ŸåŒ…å«ä»¥ä¸‹10ä¸ªæ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š

| æ¨¡å— | ä¸»è¦åŠŸèƒ½ | æ ¸å¿ƒç‰¹æ€§ |
|------|----------|----------|
| **ç­–ç•¥ç®¡ç†** | é…é¢å……å€¼ç­–ç•¥çš„åˆ›å»ºå’Œæ‰§è¡Œ | æ”¯æŒä¸€æ¬¡æ€§/å‘¨æœŸæ€§ç­–ç•¥ã€æ¡ä»¶è¡¨è¾¾å¼ã€å®šæ—¶æ‰§è¡Œ |
| **é…é¢ç®¡ç†** | ç”¨æˆ·é…é¢çš„åˆ†é…ã€è½¬è´¦å’Œè¿‡æœŸå¤„ç† | å…‘æ¢ç è½¬è´¦ã€å¤šè¿‡æœŸæ—¶é—´ã€å®¡è®¡è·Ÿè¸ª |
| **æƒé™ç®¡ç†** | æ¨¡å‹è®¿é—®æƒé™çš„ç²¾ç»†åŒ–æ§åˆ¶ | ç”¨æˆ·/éƒ¨é—¨çº§æƒé™ã€å±‚çº§ç»§æ‰¿ã€å®æ—¶åŒæ­¥ |
| **Staræ£€æŸ¥æƒé™** | GitHub Staræ£€æŸ¥å¼€å…³ç®¡ç† | ç”¨æˆ·/éƒ¨é—¨çº§æ§åˆ¶ã€ä¼˜å…ˆçº§ç®¡ç† |
| **é…é¢æ£€æŸ¥æƒé™** | é…é¢æ£€æŸ¥å¼€å…³ç®¡ç† | ç”¨æˆ·/éƒ¨é—¨çº§æ§åˆ¶ã€é»˜è®¤ç­–ç•¥ |
| **å‘˜å·¥åŒæ­¥** | HRç³»ç»Ÿæ•°æ®è‡ªåŠ¨åŒæ­¥ | å®šæ—¶åŒæ­¥ã€æ‰‹åŠ¨è§¦å‘ã€æƒé™è‡ªåŠ¨æ›´æ–° |
| **æ¡ä»¶è¡¨è¾¾å¼** | å¤æ‚ä¸šåŠ¡é€»è¾‘çš„è¡¨è¾¾å¼è§£æ | æ”¯æŒ11ç§å‡½æ•°ã€é€»è¾‘è¿ç®—ã€çµæ´»ç»„åˆ |
| **å…‘æ¢ç ç³»ç»Ÿ** | å®‰å…¨çš„é…é¢è½¬è´¦æœºåˆ¶ | HMAC-SHA256ç­¾åã€é˜²é‡å¤å…‘æ¢ |
| **å®šæ—¶ä»»åŠ¡** | è‡ªåŠ¨åŒ–ä»»åŠ¡è°ƒåº¦æ‰§è¡Œ | Cronè°ƒåº¦ã€ç­–ç•¥æ‰§è¡Œã€è¿‡æœŸå¤„ç† func (s *SchedulerService) Start() |
| **AiGatewayé›†æˆ** | ä¸AIç½‘å…³çš„æ•°æ®åŒæ­¥ | é…é¢åŒæ­¥ã€æƒé™åŒæ­¥ã€å®æ—¶æ›´æ–° |

---

### è¯¦ç»†æ¨¡å—åˆ†æ

### 1. ç­–ç•¥ç®¡ç† (Strategy Management)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/strategy.go`, `internal/handlers/strategy.go`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- ä¸€æ¬¡æ€§å’Œå‘¨æœŸæ€§å……å€¼ç­–ç•¥ç±»å‹
- ç­–ç•¥çŠ¶æ€æ§åˆ¶ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- å¤æ‚æ¡ä»¶åŒ¹é…ï¼ˆæ”¯æŒé«˜çº§å‡½æ•°æ¡ä»¶è¡¨è¾¾å¼ï¼‰
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼ˆåŸºäº Cron è¡¨è¾¾å¼ï¼‰
- ç­–ç•¥æ‰§è¡Œè®°å½•è·Ÿè¸ª

**ä¸»è¦ APIï¼š**
- `POST /quota-manager/api/v1/strategies` - åˆ›å»ºç­–ç•¥
- `GET /quota-manager/api/v1/strategies` - è·å–ç­–ç•¥åˆ—è¡¨
- `PUT /quota-manager/api/v1/strategies/:id` - æ›´æ–°ç­–ç•¥
- `POST /quota-manager/api/v1/strategies/:id/enable` - å¯ç”¨ç­–ç•¥
- `POST /quota-manager/api/v1/strategies/:id/disable` - ç¦ç”¨ç­–ç•¥

### 2. é…é¢ç®¡ç† (Quota Management)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/quota.go`, `internal/handlers/quota.go`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- é…é¢è¿‡æœŸç®¡ç†ï¼ˆåŸºäºæ—¶é—´çš„é…é¢ç®¡ç†ï¼‰
- é…é¢è½¬è´¦åŠŸèƒ½ï¼ˆä½¿ç”¨å…‘æ¢ç ï¼‰
- å®¡è®¡è·Ÿè¸ªï¼ˆå…¨é¢çš„é…é¢æ“ä½œè·Ÿè¸ªï¼‰
- å¤šç§è¿‡æœŸæ—¥æœŸæ”¯æŒ
- ä¸ AiGateway æœåŠ¡å®æ—¶åŒæ­¥

**ä¸»è¦ APIï¼š**
- `GET /quota-manager/api/v1/quota` - è·å–ç”¨æˆ·é…é¢
- `POST /quota-manager/api/v1/quota/transfer-out` - è½¬å‡ºé…é¢
- `POST /quota-manager/api/v1/quota/transfer-in` - è½¬å…¥é…é¢
- `GET /quota-manager/api/v1/quota/audit` - è·å–é…é¢å®¡è®¡è®°å½•

### 3. æƒé™ç®¡ç† (Permission Management)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/permission.go`, `internal/handlers/model_permission.go`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- æ¨¡å‹è®¿é—®æƒé™ç®¡ç†
- ç”¨æˆ·å’Œéƒ¨é—¨çº§åˆ«çš„ç»†ç²’åº¦æ§åˆ¶
- éƒ¨é—¨å±‚çº§æƒé™ç»§æ‰¿
- ä¸ AI Gateway çš„è‡ªåŠ¨æƒé™åŒæ­¥
- å®¡è®¡è·Ÿè¸ª

**ä¸»è¦ APIï¼š**
- `POST /quota-manager/api/v1/model-permissions/user` - è®¾ç½®ç”¨æˆ·ç™½åå•
- `POST /quota-manager/api/v1/model-permissions/department` - è®¾ç½®éƒ¨é—¨ç™½åå•

### 4. Star æ£€æŸ¥æƒé™ç®¡ç† (Star Check Permission)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/star_check_permission.go`, `internal/handlers/star_check_permission.go`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- GitHub Star æ£€æŸ¥å¼€å…³ç®¡ç†
- ç”¨æˆ·å’Œéƒ¨é—¨çº§åˆ«æ§åˆ¶
- æƒé™ç»§æ‰¿æœºåˆ¶
- ä¼˜å…ˆçº§ç®¡ç†ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆäºéƒ¨é—¨è®¾ç½®ï¼‰

**ä¸»è¦ APIï¼š**
- `POST /quota-manager/api/v1/star-check-permissions/user` - è®¾ç½®ç”¨æˆ· Star æ£€æŸ¥å¼€å…³
- `POST /quota-manager/api/v1/star-check-permissions/department` - è®¾ç½®éƒ¨é—¨ Star æ£€æŸ¥å¼€å…³

### 5. é…é¢æ£€æŸ¥æƒé™ç®¡ç† (Quota Check Permission)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/quota_check_permission.go`, `internal/handlers/quota_check_permission.go`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- é…é¢æ£€æŸ¥å¼€å…³ç®¡ç†
- ç”¨æˆ·å’Œéƒ¨é—¨çº§åˆ«æ§åˆ¶
- é»˜è®¤ç¦ç”¨ç­–ç•¥
- æƒé™ç»§æ‰¿å’Œä¼˜å…ˆçº§ç®¡ç†

**ä¸»è¦ APIï¼š**
- `POST /quota-manager/api/v1/quota-check-permissions/user` - è®¾ç½®ç”¨æˆ·é…é¢æ£€æŸ¥å¼€å…³
- `POST /quota-manager/api/v1/quota-check-permissions/department` - è®¾ç½®éƒ¨é—¨é…é¢æ£€æŸ¥å¼€å…³

### 6. å‘˜å·¥åŒæ­¥ (Employee Sync)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/employee_sync.go`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- è‡ªåŠ¨åŒ– HR ç³»ç»Ÿé›†æˆ
- å‘˜å·¥å’Œéƒ¨é—¨æ•°æ®åŒæ­¥
- å®šæ—¶åŒæ­¥ï¼ˆæ¯å¤©å‡Œæ™¨ 1:00ï¼‰
- æ‰‹åŠ¨è§¦å‘åŒæ­¥
- æƒé™è‡ªåŠ¨æ›´æ–°

### 7. æ¡ä»¶è¡¨è¾¾å¼ç³»ç»Ÿ (Condition Expression)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/condition/parser.go`, `internal/condition/adapters.go`

**æ”¯æŒçš„å‡½æ•°ï¼š**
- `access-after(timestamp)` - æŒ‡å®šæ—¶é—´åçš„æœ€åè®¿é—®
- `and(condition1, condition2)` - é€»è¾‘ä¸
- `belong-to(org1, org2)` - å±äºæŒ‡å®šç»„ç»‡æˆ–éƒ¨é—¨
- `false()` - å§‹ç»ˆè¿”å› false
- `github-star(project)` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºæŒ‡å®šé¡¹ç›®åŠ æ˜Ÿ
- `is-vip(level)` - VIP ç­‰çº§æ£€æŸ¥
- `match-user("user1", "user2", ...)` - åŒ¹é…ç”¨æˆ·ID
- `not(condition)` - é€»è¾‘é
- `or(condition1, condition2)` - é€»è¾‘æˆ–
- `quota-le(model, amount)` - é…é¢ä½™é¢æ£€æŸ¥
- `register-before(timestamp)` - æŒ‡å®šæ—¶é—´å‰æ³¨å†Œ
- `true()` - å§‹ç»ˆè¿”å› true

### 8. å…‘æ¢ç ç³»ç»Ÿ (Voucher System)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/voucher.go`

**å®‰å…¨ç‰¹æ€§ï¼š**
- HMAC-SHA256 ç­¾åéªŒè¯
- Base64URL ç¼–ç 
- é‡å¤å…‘æ¢é˜²æŠ¤
- æ—¶é—´æˆ³éªŒè¯

### 9. å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ (Scheduler)
**æ–‡ä»¶ä½ç½®ï¼š** `internal/services/scheduler.go`

**ä»»åŠ¡ç±»å‹ï¼š**
- ç­–ç•¥æ‰§è¡Œä»»åŠ¡ï¼ˆæ¯å°æ—¶æ‰§è¡Œï¼‰
- é…é¢è¿‡æœŸä»»åŠ¡ï¼ˆæ¯æœˆç¬¬ä¸€å¤© 00:01ï¼‰
- å‘˜å·¥åŒæ­¥ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ 1:00ï¼‰

### 10. AiGateway é›†æˆ
**æ–‡ä»¶ä½ç½®ï¼š** `pkg/aigateway/client.go`, `internal/services/aigateway_admin.go`

**é›†æˆåŠŸèƒ½ï¼š**
- é…é¢åˆ·æ–°å’ŒæŸ¥è¯¢
- å·²ä½¿ç”¨é…é¢ç®¡ç†
- Star é¡¹ç›®ç®¡ç†
- æƒé™åŒæ­¥
- æ¨¡å‹æƒé™è®¾ç½®

## æ•°æ®åº“æ¶æ„

### æ ¸å¿ƒè¡¨ç»“æ„

#### ç­–ç•¥ç›¸å…³è¡¨
- `quota_strategy` - é…é¢ç­–ç•¥è¡¨
- `quota_execute` - ç­–ç•¥æ‰§è¡ŒçŠ¶æ€è¡¨

#### é…é¢ç›¸å…³è¡¨
- `quota` - ç”¨æˆ·é…é¢è¡¨
- `quota_audit` - é…é¢å®¡è®¡è¡¨
- `voucher_redemption` - å…‘æ¢ç å…‘æ¢è¡¨
- `monthly_quota_usage` - æœˆåº¦é…é¢ä½¿ç”¨è®°å½•è¡¨

#### ç”¨æˆ·è®¤è¯è¡¨
- `auth_users` - ç”¨æˆ·ä¿¡æ¯è¡¨ï¼ˆä½äºç‹¬ç«‹çš„ auth æ•°æ®åº“ï¼‰

#### æƒé™ç®¡ç†è¡¨
- `employee_department` - å‘˜å·¥éƒ¨é—¨è¡¨
- `model_whitelist` - æ¨¡å‹ç™½åå•è¡¨
- `effective_permissions` - æœ‰æ•ˆæƒé™è¡¨
- `permission_audit` - æƒé™å®¡è®¡è¡¨

#### Star æ£€æŸ¥è¡¨
- `star_check_settings` - Star æ£€æŸ¥è®¾ç½®è¡¨
- `effective_star_check_settings` - æœ‰æ•ˆ Star æ£€æŸ¥è®¾ç½®è¡¨

#### é…é¢æ£€æŸ¥è¡¨
- `quota_check_settings` - é…é¢æ£€æŸ¥è®¾ç½®è¡¨
- `effective_quota_check_settings` - æœ‰æ•ˆé…é¢æ£€æŸ¥è®¾ç½®è¡¨

## é…ç½®ç³»ç»Ÿ

### ä¸»è¦é…ç½®é¡¹
```yaml
server:           # æœåŠ¡å™¨é…ç½®
  port: 8099
  mode: "release"
  token_header: "authorization"

database:         # ä¸»æ•°æ®åº“é…ç½®
  host: "127.0.0.1"
  port: 5432
  user: "keycloak"
  password: "sf2025~SHENMA"
  dbname: "quota_manager"

auth_database:    # è®¤è¯æ•°æ®åº“é…ç½®
  host: "127.0.0.1"
  port: 5432
  user: "keycloak"
  password: "sf2025~SHENMA"
  dbname: "auth"

aigateway:        # AiGateway é›†æˆé…ç½®
  host: "127.0.0.1"
  port: 8002
  admin_path: "/v1/chat/completions/quota"
  auth_header: "x-admin-key"
  auth_value: "12345678"

employee_sync:    # å‘˜å·¥åŒæ­¥é…ç½®
  enabled: false
  hr_url: "http://localhost:8099/api/hr/employees"
  hr_key: "test-hr-key"
  dept_url: "http://localhost:8099/api/hr/departments"
  dept_key: "test-dept-key"

voucher:          # å…‘æ¢ç é…ç½®
  signing_key: "your-secret-signing-key-at-least-32-bytes-long-for-security"

log:              # æ—¥å¿—é…ç½®
  level: "warn"
  stdout_only: true

timezone: "Asia/Shanghai"  # æ—¶åŒºé…ç½®
```

## æµ‹è¯•ç³»ç»Ÿ

### æµ‹è¯•è¦†ç›–èŒƒå›´
- **æ¡ä»¶è¡¨è¾¾å¼æµ‹è¯•**ï¼šæ‰€æœ‰æ”¯æŒçš„å‡½æ•°å’Œé€»è¾‘ç»„åˆ
- **ç­–ç•¥ç±»å‹æµ‹è¯•**ï¼šä¸€æ¬¡æ€§å’Œå‘¨æœŸæ€§ç­–ç•¥
- **çŠ¶æ€æ§åˆ¶æµ‹è¯•**ï¼šå¯ç”¨/ç¦ç”¨åŠŸèƒ½
- **é…é¢è½¬è´¦æµ‹è¯•**ï¼šè½¬å‡º/è½¬å…¥æ“ä½œ
- **å®¡è®¡è·Ÿè¸ªæµ‹è¯•**ï¼šè®°å½•è·Ÿè¸ªå’ŒæŸ¥è¯¢
- **è¿‡æœŸç®¡ç†æµ‹è¯•**ï¼šåŸºäºæ—¶é—´çš„é…é¢å¤„ç†
- **æƒé™ç®¡ç†æµ‹è¯•**ï¼šæ¨¡å‹æƒé™ã€Star æ£€æŸ¥æƒé™ã€é…é¢æ£€æŸ¥æƒé™
- **AiGateway é›†æˆæµ‹è¯•**ï¼šæ­£å¸¸å’Œå¤±è´¥åœºæ™¯
- **å¹¶å‘æµ‹è¯•**ï¼šå¤šç”¨æˆ·å¹¶å‘æ“ä½œ
- **éªŒè¯æµ‹è¯•**ï¼šè¾“å…¥éªŒè¯å’Œæ¨¡å¼éªŒè¯

### æµ‹è¯•è¿è¡Œæ–¹å¼
```bash
# è¿è¡Œé›†æˆæµ‹è¯•
cd test
chmod +x run_tests.sh
./run_tests.sh

# æˆ–æ‰‹åŠ¨è¿è¡Œ
go run main.go
```

## éƒ¨ç½²å’Œè¿ç»´

### Docker æ”¯æŒ
- `Dockerfile` - ä¸»åº”ç”¨å®¹å™¨æ„å»º
- `docker-compose.yml` - å®Œæ•´ç¯å¢ƒç¼–æ’
- `scripts/aigateway-mock/Dockerfile` - æ¨¡æ‹ŸæœåŠ¡å®¹å™¨

### å¯åŠ¨è„šæœ¬
- `scripts/start.sh` - å®Œæ•´å¯åŠ¨è„šæœ¬
- `scripts/test_api.sh` - API æµ‹è¯•è„šæœ¬

### æ•°æ®åº“åˆå§‹åŒ–
- `scripts/init_db.sql` - å®Œæ•´çš„æ•°æ®åº“ç»“æ„åˆå§‹åŒ–è„šæœ¬

## å®‰å…¨ç‰¹æ€§

1. **JWT è®¤è¯**ï¼šæ‰€æœ‰ API ç«¯ç‚¹éƒ½éœ€è¦æœ‰æ•ˆçš„ JWT ä»¤ç‰Œ
2. **HMAC-SHA256 å…‘æ¢ç **ï¼šåŠ å¯†ç­¾åçš„å…‘æ¢ç ç³»ç»Ÿ
3. **é‡å¤é˜²æŠ¤**ï¼šé˜²æ­¢é‡å¤å…‘æ¢å’Œæ“ä½œ
4. **äº‹åŠ¡å®‰å…¨**ï¼šæ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **æƒé™åˆ†çº§**ï¼šç”¨æˆ·ã€éƒ¨é—¨å¤šçº§æƒé™æ§åˆ¶
6. **å®¡è®¡è·Ÿè¸ª**ï¼šå®Œæ•´çš„æ“ä½œè®°å½•å’Œå®¡è®¡

## æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ç´¢å¼•**ï¼šå…³é”®å­—æ®µå»ºç«‹é«˜æ•ˆç´¢å¼•
2. **è¿æ¥æ± **ï¼šæ•°æ®åº“è¿æ¥æ± ç®¡ç†
3. **æ‰¹å¤„ç†**ï¼šå¤§å‹æ“ä½œçš„æ‰¹é‡å¤„ç†
4. **ç¼“å­˜æœºåˆ¶**ï¼šé…ç½®å’Œæƒé™æ•°æ®ç¼“å­˜
5. **å¼‚æ­¥å¤„ç†**ï¼šå®šæ—¶ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ

## ç›‘æ§å’Œæ—¥å¿—

1. **ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨ Zap è¿›è¡Œ JSON æ ¼å¼æ—¥å¿—è®°å½•
2. **å¥åº·æ£€æŸ¥**ï¼š`/quota-manager/health` ç«¯ç‚¹
3. **é”™è¯¯è·Ÿè¸ª**ï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
4. **æ€§èƒ½æŒ‡æ ‡**ï¼šæ“ä½œæ‰§è¡Œæ—¶é—´å’Œèµ„æºä½¿ç”¨è·Ÿè¸ª
5. **å®¡è®¡æ—¥å¿—**ï¼šæ‰€æœ‰å…³é”®æ“ä½œçš„å®¡è®¡è®°å½•

## æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æï¼šé…é¢è®¡ç®—ä¸æ‰£é™¤

### 1. é…é¢ç®¡ç†æ¨¡å¼ï¼šæœ¬åœ°è®°è´¦ + å¤–éƒ¨æ¶ˆè€—

ä¸ºäº†å®ç°é«˜æ€§èƒ½å’ŒèŒè´£åˆ†ç¦»ï¼Œç³»ç»Ÿé‡‡ç”¨äº†**æœ¬åœ°æ•°æ®åº“è®°è´¦**ä¸**å¤–éƒ¨æœåŠ¡æ¶ˆè€—è®¡é‡**ç›¸ç»“åˆçš„æ··åˆæ¨¡å¼ã€‚

- **`quota-manager` (æœ¬åœ°æ•°æ®åº“)**: è´Ÿè´£é…é¢çš„**ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼Œåƒä¸€ä¸ª**æ€»è´¦æœ¬**ã€‚å®ƒè®°å½•äº†æ‰€æœ‰é…é¢çš„æˆäºˆï¼ˆ`INSERT`ï¼‰ã€å†…éƒ¨è½¬ç§»/æ‰£å‡ï¼ˆ`UPDATE`ï¼‰å’Œè¿‡æœŸå¤„ç†ã€‚
- **`AiGateway` (å¤–éƒ¨æœåŠ¡)**: è´Ÿè´£é…é¢çš„**å®æ—¶æ¶ˆè€—è®¡é‡**ï¼Œåƒä¸€ä¸ª**é«˜é¢‘æ¶ˆè´¹è®°å½•å™¨**ã€‚å®ƒç‹¬ç«‹è®°å½•ç”¨æˆ·çš„æ—¥å¸¸ä½¿ç”¨æ¶ˆè€—ï¼ˆ`usedQuota`ï¼‰ï¼Œè€Œä¸ç›´æ¥ä¿®æ”¹ `quota-manager` çš„æ€»è´¦æœ¬ã€‚

### 2. `quota.Amount` å­—æ®µçš„æ ¸å¿ƒå«ä¹‰

`quota` è¡¨ä¸­çš„ `Amount` å­—æ®µæ˜¯ç†è§£æœ¬ç³»ç»Ÿçš„å…³é”®ã€‚

- **å«ä¹‰**: å®ƒä»£è¡¨**â€œç‰¹å®šæ‰¹æ¬¡æˆäºˆé¢åº¦çš„å½“å‰å‰©ä½™å€¼â€**ï¼Œå³ `åŸå§‹æˆäºˆå€¼ - æ‰€æœ‰å†…éƒ¨è´¦æœ¬æ‰£å‡`ã€‚
- **éå®æ—¶å¯ç”¨ä½™é¢**: `SUM(quota.Amount)` å¾—åˆ°çš„**ä¸æ˜¯**ç”¨æˆ·æœ€ç»ˆçš„å¯ç”¨é…é¢ï¼Œè€Œæ˜¯ä¸€ä¸ª**ç†è®ºæ€»é¢**ã€‚

### 3. `quota.Amount` çš„å˜æ›´æ—¶æœº

`quota.Amount` çš„å€¼**ä»…åœ¨ä»¥ä¸‹ä½é¢‘çš„â€œå†…éƒ¨è´¦æœ¬è°ƒæ•´â€æ“ä½œæ—¶ä¼šå‡å°‘**ï¼š

| æ“ä½œç±»å‹ | è§¦å‘å‡½æ•° | ä¸šåŠ¡åœºæ™¯ |
| :--- | :--- | :--- |
| **é…é¢è½¬å‡º** | `TransferOut` | ç”¨æˆ· A å°†é…é¢è½¬ç»™ç”¨æˆ· B æ—¶ï¼Œæ‰£å‡ A çš„ `Amount`ã€‚ |
| **æ‰‹åŠ¨æ‰£é™¤** | `DeductQuota` | ç®¡ç†å‘˜å› ç‰¹å®šåŸå› ï¼ˆå¦‚å†²æ­£ã€ç»“ç®—ï¼‰æ‰£å‡ç”¨æˆ·çš„ `Amount`ã€‚ |

**é‡è¦**: ç”¨æˆ·çš„**æ—¥å¸¸ä½¿ç”¨æ¶ˆè€—**ï¼ˆè°ƒç”¨ AI æ¨¡å‹ï¼‰ç”± `AiGateway` è®°å½•ï¼Œ**ä¸ä¼š**æ”¹å˜ `quota` è¡¨ä¸­çš„ `Amount` å€¼ã€‚

### 4. æœ€ç»ˆå¯ç”¨é…é¢çš„è®¡ç®—é€»è¾‘ (`GetUserQuota`)

ç”¨æˆ·çš„**æœ€ç»ˆå¯ç”¨é…é¢**æ˜¯ä¸€ä¸ª**åŠ¨æ€è®¡ç®—**å‡ºæ¥çš„å®æ—¶å€¼ï¼Œè®¡ç®—è¿‡ç¨‹å¥½æ¯”â€œå¯¹è´¦â€ã€‚

**è®¡ç®—å…¬å¼**:
\[ \text{æœ€ç»ˆå¯ç”¨é…é¢} = (\sum \text{æ‰€æœ‰æœ‰æ•ˆ quota.Amount}) - \text{usedQuota (æ¥è‡ª AiGateway)} \]

**æ‰§è¡Œæµç¨‹**:
1. **è·å–æ¶ˆè€—æ€»é¢**: ä» `AiGateway` è·å–æƒå¨çš„ `usedQuota`ã€‚
2. **è·å–ç†è®ºæ€»é¢**: ä»æœ¬åœ°æ•°æ®åº“ `quota` è¡¨ä¸­ï¼Œå°†ç”¨æˆ·æ‰€æœ‰ `status = 'VALID'` çš„è®°å½•çš„ `Amount` ç›¸åŠ ã€‚
3. **è®¡ç®—å·®å€¼**: `ç†è®ºæ€»é¢ - æ¶ˆè€—æ€»é¢`ï¼Œå¾—åˆ°æœ€ç»ˆå¯ç”¨é…é¢ã€‚

### 5. é…é¢æ‰£é™¤è§„åˆ™ (FIFO)

æ‰€æœ‰é…é¢çš„æ‰£é™¤ï¼ˆæ— è®ºæ˜¯å†…éƒ¨æ‰£å‡è¿˜æ˜¯å¤–éƒ¨æ¶ˆè€—çš„è®¡ç®—ï¼‰ï¼Œéƒ½éµå¾ª**å…ˆè¿›å…ˆå‡º (First-In, First-Out)** çš„åŸåˆ™ã€‚

- **è§„åˆ™**: **æœ€æ—©è¿‡æœŸçš„é…é¢æ‰¹æ¬¡ï¼Œæœ€å…ˆè¢«æ‰£é™¤**ã€‚
- **å®ç°**: æ‰€æœ‰ç›¸å…³çš„æ•°æ®åº“æŸ¥è¯¢éƒ½ä½¿ç”¨ `ORDER BY expiry_date ASC` æ¥ä¿è¯é¡ºåºã€‚

### 6. é»˜è®¤æœ‰æ•ˆæœŸè®¡ç®—è§„åˆ™ (ç¡¬ç¼–ç )

**å…³é”®ç‚¹**: ç³»ç»Ÿé»˜è®¤çš„â€œæ¬¡æœˆæœˆåº•å¤±æ•ˆâ€è§„åˆ™ï¼Œ**å¹¶éåœ¨ `config.yaml` æˆ–æ•°æ®åº“ä¸­é…ç½®ï¼Œè€Œæ˜¯ç¡¬ç¼–ç ï¼ˆHard-codedï¼‰åœ¨æ ¸å¿ƒä¸šåŠ¡ä»£ç ä¸­**ã€‚

*   **ä»£ç ä½ç½®**: `internal/services/quota.go` -> `Recharge` å‡½æ•°ã€‚
*   **æ ¸å¿ƒé€»è¾‘**: å½“ä¸€ä¸ªç­–ç•¥**æ²¡æœ‰**å®šä¹‰ `validity_days` æ—¶ï¼Œ`Recharge` å‡½æ•°ä¼šé€šè¿‡ä¸€æ®µå›ºå®šçš„æ—¥æœŸè®¡ç®—é€»è¾‘æ¥ç”Ÿæˆ `ExpiryDate`ã€‚
    ```go
    // ç®€åŒ–é€»è¾‘ï¼šå–â€œä¸‹ä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©â€ï¼Œå†å‡å»1ç§’
    expiryDate := time.Date(now.Year(), now.Month(), 1, ...).AddDate(0, 2, 0).Add(-time.Second)
    ```
    è¿™ä¸ªè®¡ç®—æ–¹å¼ç¡®ä¿äº†æ‰€æœ‰å¸¸è§„èµ é€çš„é¢åº¦ï¼Œå…¶æœ‰æ•ˆæœŸéƒ½ç»Ÿä¸€ä¸º**ä¸‹ä¸€ä¸ªæœˆçš„æœ€åä¸€å¤©**ã€‚
*   **çµæ´»æ€§æ¥æº**: æ–°å¢çš„ `validity_days` å­—æ®µï¼Œå…¶ç›®çš„æ­£æ˜¯ä¸ºäº†èƒ½å¤Ÿ**è¦†ç›–**è¿™ä¸ªé»˜è®¤çš„ç¡¬ç¼–ç è¡Œä¸ºï¼Œä»è€Œå®ç°å¦‚â€œ180å¤©æœ‰æ•ˆâ€ç­‰çµæ´»çš„æœ‰æ•ˆæœŸéœ€æ±‚ã€‚

## æ€»ç»“

Quota Manager æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ¶æ„æ¸…æ™°çš„ä¼ä¸šçº§é…é¢ç®¡ç†ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **åŠŸèƒ½å…¨é¢**ï¼šæ¶µç›–é…é¢ç®¡ç†ã€æƒé™æ§åˆ¶ã€å‘˜å·¥åŒæ­¥ç­‰å¤šä¸ªæ–¹é¢
- **å®‰å…¨å¯é **ï¼šå®Œå–„çš„è®¤è¯ã€æˆæƒå’Œå®¡è®¡æœºåˆ¶
- **æµ‹è¯•å®Œæ•´**ï¼šå…¨é¢çš„é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•
- **éƒ¨ç½²ä¾¿æ·**ï¼šDocker æ”¯æŒå’Œè‡ªåŠ¨åŒ–è„šæœ¬
- **æ–‡æ¡£è¯¦ç»†**ï¼šå®Œæ•´çš„ä¸­è‹±æ–‡æ–‡æ¡£å’Œ API è¯´æ˜

è¯¥ç³»ç»Ÿé€‚ç”¨äºéœ€è¦ç²¾ç»†åŒ–é…é¢ç®¡ç†å’Œæƒé™æ§åˆ¶çš„ä¼ä¸šç¯å¢ƒï¼Œç‰¹åˆ«æ˜¯ä¸ AI æœåŠ¡é›†æˆçš„åœºæ™¯ã€‚

## API æ¥å£æ–‡æ¡£

Quota Manager æä¾›äº†å®Œæ•´çš„ RESTful API æ¥å£ï¼Œæ‰€æœ‰æ¥å£éƒ½åœ¨ `/quota-manager/api/v1` è·¯å¾„ä¸‹ã€‚

### åŸºç¡€ä¿¡æ¯

- **Base URL**: `http://localhost:8099/quota-manager/api/v1`
- **è®¤è¯æ–¹å¼**: JWT Token (é€šè¿‡ `authorization` å¤´ä¼ é€’)
- **å“åº”æ ¼å¼**: JSON
- **CORS**: æ”¯æŒè·¨åŸŸè¯·æ±‚

### å¥åº·æ£€æŸ¥

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| GET | `/quota-manager/health` | æœåŠ¡å¥åº·æ£€æŸ¥ |

### 1. ç­–ç•¥ç®¡ç† API (Strategies)

**åŸºç¡€è·¯å¾„**: `/strategies`

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| POST | `/strategies` | åˆ›å»ºé…é¢ç­–ç•¥ | Body: ç­–ç•¥ä¿¡æ¯ |
| GET | `/strategies` | è·å–ç­–ç•¥åˆ—è¡¨ | Query: page, size, name, type, status |
| GET | `/strategies/{id}` | è·å–å•ä¸ªç­–ç•¥è¯¦æƒ… | Path: id |
| PUT | `/strategies/{id}` | æ›´æ–°ç­–ç•¥ä¿¡æ¯ | Path: id, Body: ç­–ç•¥ä¿¡æ¯ |
| DELETE | `/strategies/{id}` | åˆ é™¤ç­–ç•¥ | Path: id |
| POST | `/strategies/{id}/enable` | å¯ç”¨ç­–ç•¥ | Path: id |
| POST | `/strategies/{id}/disable` | ç¦ç”¨ç­–ç•¥ | Path: id |
| GET | `/strategies/{id}/executions` | è·å–ç­–ç•¥æ‰§è¡Œè®°å½• | Path: id, Query: page, size |

**ç­–ç•¥åˆ›å»º/æ›´æ–°å‚æ•°**:
```json
{
  "name": "ç­–ç•¥åç§°ï¼ˆå”¯ä¸€ï¼‰",
  "title": "ç­–ç•¥æ ‡é¢˜",
  "type": "single|periodic",
  "amount": 100.0,
  "model": "æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼‰",
  "periodic_expr": "Cronè¡¨è¾¾å¼ï¼ˆå‘¨æœŸæ€§ç­–ç•¥å¿…éœ€ï¼‰",
  "condition": "æ¡ä»¶è¡¨è¾¾å¼",
  "status": true,
  "validity_days": 30
}
```

### 2. é…é¢ç®¡ç† API (Quota)

**åŸºç¡€è·¯å¾„**: `/quota`

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/quota` | è·å–ç”¨æˆ·é…é¢ä¿¡æ¯ | Header: authorization |
| GET | `/quota/audit` | è·å–é…é¢å®¡è®¡è®°å½• | Query: page, size |
| POST | `/quota/transfer-out` | è½¬å‡ºé…é¢ | Body: è½¬å‡ºä¿¡æ¯ |
| POST | `/quota/transfer-in` | è½¬å…¥é…é¢ï¼ˆå…‘æ¢ï¼‰ | Body: å…‘æ¢ç ä¿¡æ¯ |
| GET | `/quota/audit/{user_id}` | è·å–æŒ‡å®šç”¨æˆ·å®¡è®¡è®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰ | Path: user_id |

**è½¬å‡ºé…é¢å‚æ•°**:
```json
{
  "receiver_id": "æ¥æ”¶æ–¹ç”¨æˆ·ID",
  "quota_list": [
    {
      "amount": 50.0,
      "expiry_date": "2025-12-31T23:59:59Z"
    }
  ]
}
```

**è½¬å…¥é…é¢å‚æ•°**:
```json
{
  "voucher_code": "å…‘æ¢ç "
}
```

### 3. æ¨¡å‹æƒé™ç®¡ç† API (Model Permissions)

**åŸºç¡€è·¯å¾„**: `/model-permissions`

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| POST | `/model-permissions/user` | è®¾ç½®ç”¨æˆ·æ¨¡å‹ç™½åå• | Body: ç”¨æˆ·æƒé™ä¿¡æ¯ |
| POST | `/model-permissions/department` | è®¾ç½®éƒ¨é—¨æ¨¡å‹ç™½åå• | Body: éƒ¨é—¨æƒé™ä¿¡æ¯ |
| GET | `/model-permissions/user` | è·å–ç”¨æˆ·æ¨¡å‹ç™½åå• | Query: user_id æˆ– employee_number |
| GET | `/model-permissions/department` | è·å–éƒ¨é—¨æ¨¡å‹ç™½åå• | Query: department_id |

**ç”¨æˆ·æƒé™è®¾ç½®å‚æ•°**:
```json
{
  "user_id": "ç”¨æˆ·ID",
  "employee_number": "å‘˜å·¥ç¼–å·",
  "models": ["gpt-3.5-turbo", "gpt-4"],
  "action": "set|add|remove"
}
```

### 4. Star æ£€æŸ¥æƒé™ç®¡ç† API (Star Check Permissions)

**åŸºç¡€è·¯å¾„**: `/star-check-permissions`

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| POST | `/star-check-permissions/user` | è®¾ç½®ç”¨æˆ· Star æ£€æŸ¥å¼€å…³ | Body: ç”¨æˆ·è®¾ç½® |
| POST | `/star-check-permissions/department` | è®¾ç½®éƒ¨é—¨ Star æ£€æŸ¥å¼€å…³ | Body: éƒ¨é—¨è®¾ç½® |
| GET | `/star-check-permissions/user` | è·å–ç”¨æˆ· Star æ£€æŸ¥è®¾ç½® | Query: user_id æˆ– employee_number |
| GET | `/star-check-permissions/department` | è·å–éƒ¨é—¨ Star æ£€æŸ¥è®¾ç½® | Query: department_id |

**è®¾ç½®å‚æ•°**:
```json
{
  "user_id": "ç”¨æˆ·ID",
  "employee_number": "å‘˜å·¥ç¼–å·",
  "enabled": true
}
```

### 5. é…é¢æ£€æŸ¥æƒé™ç®¡ç† API (Quota Check Permissions)

**åŸºç¡€è·¯å¾„**: `/quota-check-permissions`

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| POST | `/quota-check-permissions/user` | è®¾ç½®ç”¨æˆ·é…é¢æ£€æŸ¥å¼€å…³ | Body: ç”¨æˆ·è®¾ç½® |
| POST | `/quota-check-permissions/department` | è®¾ç½®éƒ¨é—¨é…é¢æ£€æŸ¥å¼€å…³ | Body: éƒ¨é—¨è®¾ç½® |
| GET | `/quota-check-permissions/user` | è·å–ç”¨æˆ·é…é¢æ£€æŸ¥è®¾ç½® | Query: user_id æˆ– employee_number |
| GET | `/quota-check-permissions/department` | è·å–éƒ¨é—¨é…é¢æ£€æŸ¥è®¾ç½® | Query: department_id |

### 6. ç»Ÿä¸€æƒé™æŸ¥è¯¢ API (Effective Permissions)

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/effective-permissions` | ç»Ÿä¸€æƒé™æŸ¥è¯¢æ¥å£ | Query: type, target_type, target_identifier |

**æŸ¥è¯¢å‚æ•°**:
- `type`: `model|star-check|quota-check`
- `target_type`: `user|department`
- `target_identifier`: ç”¨æˆ·ID/å‘˜å·¥ç¼–å·æˆ–éƒ¨é—¨ID

### 7. ç³»ç»Ÿç®¡ç† API (Scan)

| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| POST | `/scan` | è§¦å‘ç³»ç»Ÿæ‰«æä»»åŠ¡ | Body: æ‰«æç±»å‹ |

**æ‰«æç±»å‹**:
```json
{
  "type": "strategy|employee-sync|expire-quotas|sync-quotas"
}
```

### 8. AI Gateway ç®¡ç† API (AiGateway Admin)

**åŸºç¡€è·¯å¾„**: `/aigateway`

#### é…é¢ç®¡ç†
| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/aigateway/quota` | æŸ¥è¯¢ç”¨æˆ·æ€»é…é¢ | Query: user_id |
| POST | `/aigateway/quota/refresh` | åˆ·æ–°ç”¨æˆ·æ€»é…é¢ | Body: user_id, quota |
| POST | `/aigateway/quota/delta` | å¢å‡ç”¨æˆ·æ€»é…é¢ | Body: user_id, value |

#### å·²ä½¿ç”¨é…é¢ç®¡ç†
| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/aigateway/quota-used` | æŸ¥è¯¢ç”¨æˆ·å·²ä½¿ç”¨é…é¢ | Query: user_id |
| POST | `/aigateway/quota-used/refresh` | åˆ·æ–°ç”¨æˆ·å·²ä½¿ç”¨é…é¢ | Body: user_id, quota |
| POST | `/aigateway/quota-used/delta` | å¢å‡ç”¨æˆ·å·²ä½¿ç”¨é…é¢ | Body: user_id, value |

#### Star é¡¹ç›®ç®¡ç†
| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/aigateway/star/projects` | æŸ¥è¯¢ç”¨æˆ· Star é¡¹ç›® | Query: employee_number |
| POST | `/aigateway/star/projects` | è®¾ç½®ç”¨æˆ· Star é¡¹ç›® | Body: employee_number, projects |

#### æƒé™å¼€å…³ç®¡ç†
| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/aigateway/permission/star-check` | æŸ¥è¯¢ Star æ£€æŸ¥å¼€å…³ | Query: employee_number |
| POST | `/aigateway/permission/star-check` | è®¾ç½® Star æ£€æŸ¥å¼€å…³ | Body: employee_number, enabled |
| GET | `/aigateway/permission/quota-check` | æŸ¥è¯¢é…é¢æ£€æŸ¥å¼€å…³ | Query: employee_number |
| POST | `/aigateway/permission/quota-check` | è®¾ç½®é…é¢æ£€æŸ¥å¼€å…³ | Body: employee_number, enabled |

#### æ¨¡å‹æƒé™ç®¡ç†
| æ–¹æ³• | è·¯å¾„ | æè¿° | å‚æ•° |
|------|------|------|------|
| GET | `/aigateway/permission/models` | è·å–ç”¨æˆ·æ¨¡å‹æƒé™ | Query: employee_number |
| POST | `/aigateway/permission/models` | è®¾ç½®ç”¨æˆ·æ¨¡å‹æƒé™ | Body: employee_number, models |

### å“åº”æ ¼å¼

#### æˆåŠŸå“åº”
```json
{
  "code": "success",
  "message": "æ“ä½œæˆåŠŸ",
  "success": true,
  "data": {
    // å…·ä½“æ•°æ®
  }
}
```

#### é”™è¯¯å“åº”
```json
{
  "code": "error_code",
  "message": "é”™è¯¯æè¿°",
  "success": false
}
```

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | æè¿° |
|--------|------|
| `bad_request` | è¯·æ±‚å‚æ•°é”™è¯¯ |
| `unauthorized` | æœªæˆæƒè®¿é—® |
| `forbidden` | æƒé™ä¸è¶³ |
| `not_found` | èµ„æºä¸å­˜åœ¨ |
| `internal_server_error` | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| `strategy_not_found` | ç­–ç•¥ä¸å­˜åœ¨ |
| `user_not_found` | ç”¨æˆ·ä¸å­˜åœ¨ |
| `insufficient_quota` | é…é¢ä¸è¶³ |
| `voucher_invalid` | å…‘æ¢ç æ— æ•ˆ |
| `employee_sync_failed` | å‘˜å·¥åŒæ­¥å¤±è´¥ |

### åˆ†é¡µå‚æ•°

å¤§å¤šæ•°åˆ—è¡¨æ¥å£æ”¯æŒåˆ†é¡µï¼š
- `page`: é¡µç ï¼ˆä»1å¼€å§‹ï¼Œé»˜è®¤1ï¼‰
- `size`: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤10ï¼Œæœ€å¤§100ï¼‰

### æ—¶é—´æ ¼å¼

æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ RFC3339 æ ¼å¼ï¼š`2006-01-02T15:04:05Z07:00`